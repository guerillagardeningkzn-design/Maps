<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Table Mountain Quest - Hex Sectors</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            background: #0d1117;
            font-family: Arial, sans-serif;
            color: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        #game-container {
            position: relative;
            width: 800px;
            height: 439px;
            border: 2px solid #ffffff;
            overflow: hidden;
        }
        #info {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(0, 0, 0, 0.75);
            color: #ffffff;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 20;
        }
        #message {
            position: absolute;
            bottom: 15px;
            left: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.75);
            color: #ffffff;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 20;
        }
        #reset {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 8px 16px;
            background: #ffcc66;
            color: #000;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            z-index: 20;
        }
        #reset:hover {
            background: #ffdd88;
        }
        #map-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: grab;
        }
        #map-svg:active {
            cursor: grabbing;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <svg id="map-svg" viewBox="0 0 800 439" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
            <defs>
                <pattern id="clouds" x="0" y="0" width="80" height="80" patternUnits="userSpaceOnUse" patternTransform="rotate(45)">
                    <rect width="80" height="80" fill="rgba(200, 220, 255, 0.7)"/>
                    <circle cx="15" cy="20" r="12" fill="rgba(230, 240, 255, 0.9)" opacity="0.6"/>
                    <circle cx="65" cy="35" r="18" fill="rgba(210, 230, 255, 0.8)" opacity="0.5"/>
                    <circle cx="40" cy="65" r="10" fill="rgba(255, 255, 255, 0.6)" opacity="0.7"/>
                    <circle cx="25" cy="50" r="8" fill="rgba(220, 240, 255, 0.8)" opacity="0.4"/>
                    <circle cx="55" cy="15" r="14" fill="rgba(190, 220, 255, 0.7)" opacity="0.6"/>
                    <circle cx="5" cy="55" r="9" fill="rgba(255, 255, 255, 0.5)" opacity="0.8"/>
                </pattern>
            </defs>
            <g id="map-group">
                <image id="map-image" xlink:href="https://capetrekking.co.za/media/images/Cape-Town-Birds-Eye-View-Map.width-800.jpg" x="0" y="0" width="800" height="439" preserveAspectRatio="xMidYMid slice"/>
                <g id="hex-group"></g>
            </g>
        </svg>
        <div id="info">
            Score: <span id="score">0</span> | Zones Revealed: <span id="revealed-count">0</span>/7
        </div>
        <div id="message">Click hexagonal sectors to explore! Drag to pan, mouse wheel to zoom.</div>
        <button id="reset">Reset Quest</button>
    </div>

    <script>
        const container = document.getElementById('game-container');
        const svg = document.getElementById('map-svg');
        const mapGroup = document.getElementById('map-group');
        const hexGroup = document.getElementById('hex-group');
        const scoreEl = document.getElementById('score');
        const revealedCountEl = document.getElementById('revealed-count');
        const messageEl = document.getElementById('message');
        const resetBtn = document.getElementById('reset');

        let score = 0;
        let revealedCount = 0;
        let totalZones = 0;
        let revealed = [];
        let hexData = [];
        let centerIdx = -1;
        let zoom = 1;
        let panX = 0;
        let panY = 0;
        let isDragging = false;
        let lastClientX = 0;
        let lastClientY = 0;
        let dragStartX = 0;
        let dragStartY = 0;

        const vbWidth = 800;
        const vbHeight = 439;
        const rings = 1;
        const hexSize = 68;
        const centerX = vbWidth / 2;
        const centerY = vbHeight / 2;
        const winThreshold = 30;

        const events = [
            { text: 'Found ancient San rock art! +10 points', points: 10 },
            { text: "Dassies scamper by. Adorable! +2 points", points: 2 },
            { text: 'Sudden mist engulfs you. -3 points', points: -3 },
            { text: 'Breathtaking 360° panorama! +7 points', points: 7 },
            { text: 'Rare proteas in bloom. +4 points', points: 4 },
            { text: 'Slippery rocks – watch your step! -5 points', points: -5 },
            { text: 'Secret fynbos trail discovered. +6 points', points: 6 },
            { text: 'Echoes of cable car in distance. +3 points', points: 3 }
        ];

        function hexCorner(cx, cy, size, i) {
            const angleDeg = 60 * i + 30;
            const angleRad = Math.PI / 180 * angleDeg;
            return {
                x: cx + size * Math.cos(angleRad),
                y: cy + size * Math.sin(angleRad)
            };
        }

        function addHex(q, r, idx) {
            const pixelX = centerX + hexSize * Math.sqrt(3) * (q + r * 0.5);
            const pixelY = centerY + hexSize * (3 / 2) * r;
            const corners = [];
            for (let i = 0; i < 6; i++) {
                const corner = hexCorner(pixelX, pixelY, hexSize, i);
                corners.push(`\( {corner.x}, \){corner.y}`);
            }
            const points = corners.join(' ');
            const poly = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            poly.setAttribute('points', points);
            poly.setAttribute('fill', 'url(#clouds)');
            poly.setAttribute('stroke', '#000000');
            poly.setAttribute('stroke-width', '1.5');
            poly.setAttribute('stroke-linejoin', 'round');
            poly.setAttribute('data-idx', idx);
            poly.style.cursor = 'pointer';
            poly.style.transition = 'fill 0.3s ease-out';
            hexGroup.appendChild(poly);
            return poly;
        }

        function generateHexes() {
            hexData = [];
            let idx = 0;
            for (let dq = -rings; dq <= rings; dq++) {
                const minR = Math.max(-rings, -dq - rings);
                const maxR = Math.min(rings, -dq + rings);
                for (let dr = minR; dr <= maxR; dr++) {
                    hexData.push({ q: dq, r: dr });
                    addHex(dq, dr, idx);
                    idx++;
                }
            }
            totalZones = hexData.length;
            revealedCountEl.textContent = `0/${totalZones}`;
            // Find center
            for (let i = 0; i < hexData.length; i++) {
                if (hexData[i].q === 0 && hexData[i].r === 0) {
                    centerIdx = i;
                    break;
                }
            }
        }

        function exploreZone(idx, silent = false) {
            if (revealed[idx]) return;
            revealed[idx] = true;
            const poly = hexGroup.children[idx];
            poly.setAttribute('fill', 'transparent');
            poly.setAttribute('stroke', '#00ff00');
            poly.setAttribute('stroke-width', '3');
            revealedCount++;
            updateUI();
            if (!silent) {
                const event = events[Math.floor(Math.random() * events.length)];
                score += event.points;
                let msg = event.text;
                if (score < 0) {
                    msg += ' | Game Over: Lost in the mist!';
                } else if (revealedCount === totalZones) {
                    if (score >= winThreshold) {
                        msg += `<br><strong>Victory! Table Mountain Master Explorer!</strong>`;
                    } else {
                        msg += `<br>Map conquered, but score low. Try again!`;
                    }
                }
                messageEl.innerHTML = msg;
                updateUI();
            }
        }

        function updateUI() {
            scoreEl.textContent = score;
            revealedCountEl.textContent = `\( {revealedCount}/ \){totalZones}`;
        }

        function updateTransform() {
            mapGroup.setAttribute('transform', `translate(${panX} \( {panY}) scale( \){zoom})`);
        }

        function clampPan() {
            panX = Math.max(vbWidth * (1 - zoom), Math.min(panX, 0));
            panY = Math.max(vbHeight * (1 - zoom), Math.min(panY, 0));
            updateTransform();
        }

        function initGame() {
            score = 0;
            revealedCount = 0;
            revealed = new Array(totalZones).fill(false);
            hexGroup.innerHTML = '';
            generateHexes();
            // Auto-reveal center
            if (centerIdx !== -1) {
                exploreZone(centerIdx, true);
            }
            panX = 0;
            panY = 0;
            zoom = 1;
            updateTransform();
            clampPan();
            updateUI();
            messageEl.innerHTML = 'Center sector revealed. Click hexes to explore! Drag to pan, wheel to zoom.';
        }

        // Event listeners
        svg.addEventListener('wheel', (e) => {
            e.preventDefault();
            const rect = svg.getBoundingClientRect();
            const viewX = (e.clientX - rect.left) / rect.width * vbWidth;
            const viewY = (e.clientY - rect.top) / rect.height * vbHeight;
            const zoomFactor = e.deltaY > 0 ? 0.85 : 1.18;
            let newZoom = zoom * zoomFactor;
            newZoom = Math.max(0.4, Math.min(4.5, newZoom));
            const factor = newZoom / zoom;
            panX = viewX * (1 - factor) + panX * factor;
            panY = viewY * (1 - factor) + panY * factor;
            zoom = newZoom;
            updateTransform();
            clampPan();
        }, { passive: false });

        svg.addEventListener('mousedown', (e) => {
            if (e.target.tagName === 'polygon') {
                // Prioritize hex clicks, but allow drag start
            }
            dragStartX = e.clientX;
            dragStartY = e.clientY;
            lastClientX = e.clientX;
            lastClientY = e.clientY;
            isDragging = false;
            svg.style.cursor = 'grabbing';
        });

        svg.addEventListener('mousemove', (e) => {
            if (Math.hypot(e.clientX - dragStartX, e.clientY - dragStartY) < 4) return;
            if (!isDragging) {
                isDragging = true;
                lastClientX = dragStartX;
                lastClientY = dragStartY;
            }
            if (!isDragging) return;
            const dx = (e.clientX - lastClientX) / zoom;
            const dy = (e.clientY - lastClientY) / zoom;
            panX += dx;
            panY += dy;
            lastClientX = e.clientX;
            lastClientY = e.clientY;
            updateTransform();
            clampPan();
        });

        svg.addEventListener('mouseup', () => {
            isDragging = false;
            svg.style.cursor = 'grab';
        });

        svg.addEventListener('mouseleave', () => {
            isDragging = false;
            svg.style.cursor = 'grab';
        });

        svg.addEventListener('click', (e) => {
            if (e.target.tagName === 'polygon') {
                const idx = parseInt(e.target.dataset.idx);
                exploreZone(idx);
            }
        });

        resetBtn.addEventListener('click', initGame);

        // Start
        initGame();
    </script>
</body>
</html>
